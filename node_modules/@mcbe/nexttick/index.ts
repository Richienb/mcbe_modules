
import ruacore from "@mcbe/ruacore_server";

export class NextTick
{
    private canceled = false;

    constructor(private readonly fn:()=>void)
    {
    }

    cancel():void
    {
        this.canceled = true;
    }
    

    call():void
    {
        if (this.canceled) return;
        try
        {
            this.fn();
        }
        catch (err)
        {
            console.error(err);
        }
    }
}

const nextFrames:NextTick[] = [];

export function callAtNextTick(fn:()=>void):NextTick
{
    const nt = new NextTick(fn);
    nextFrames.push(nt);
    return nt;
}

export function nextTickOnUpdate():void
{
    if (nextFrames.length !== 0)
    {
        const copied = nextFrames.slice();
        nextFrames.length = 0;
        for (const nextTick of copied)
        {
            nextTick.call();
        }
    }
}

ruacore.update.on(nextTickOnUpdate);